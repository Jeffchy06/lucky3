<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026週年慶抽獎輪盤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; }
        #wheel-container { position: relative; width: 400px; height: 400px; margin: 0 auto; }
        #canvas { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); will-change: transform; }
        .pointer {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-top: 50px solid #ef4444; z-index: 50; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .prize-chip { transition: all 0.2s; cursor: pointer; border: 2px solid #e2e8f0; display: flex; align-items: center; gap: 4px; }
        .prize-chip.active { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        .delete-prize { color: #ef4444; font-weight: bold; margin-left: 4px; }
        
        /* 隱藏觸發器的視覺調整：移除所有互動暗示 */
        #secret-trigger { cursor: default; user-select: none; -webkit-user-select: none; }
        #admin-title { cursor: default; user-select: none; -webkit-user-select: none; }

        /* 隱藏確認紅點：現在放置在後台按鈕下方 */
        #status-indicator {
            width: 6px;
            height: 6px;
            background-color: #ef4444;
            border-radius: 50%;
            margin: 8px auto 0;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        #status-indicator.flash { opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col lg:flex-row">
        <!-- 控制區 -->
        <div class="w-full lg:w-96 p-8 bg-slate-50 border-r">
            <h1 id="secret-trigger" class="text-2xl font-black mb-8 text-slate-800">抽獎系統</h1>
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">當前獎項</label>
                    <button onclick="openAddPrizeModal()" class="text-[10px] font-bold text-white bg-blue-600 px-3 py-1 rounded-full hover:bg-blue-700 transition-colors">+ 新增獎項</button>
                </div>
                <div class="flex justify-between items-center mb-2">
                     <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">本獎已抽: <span id="prize-draw-count">0</span> 次</span>
                </div>
                <input id="current-prize-input" type="text" class="w-full p-4 border-2 rounded-2xl font-black text-blue-600 text-2xl mb-4 bg-white shadow-sm outline-none" value="頭獎" readonly>
                <div id="prize-list" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-1"></div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">名單</label>
                    <span id="participant-count-display" class="text-[10px] font-bold text-slate-400">人數: 0</span>
                </div>
                <textarea id="names-input" class="w-full h-64 p-4 border-2 rounded-2xl font-bold text-slate-600 text-sm focus:border-blue-500 outline-none bg-white shadow-inner" oninput="updateNames()">Phoebe
May Ko
Raymond
Becky
Grace
Emmy
Karen
Yaki
Maybo
Jamie
Yoga
Yan
Venus
Wing
Yen
Ying
Jeff
Ming
Nathan
細郭生
Bella</textarea>
            </div>
            <button onclick="initWheel()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-black transition-all">更新轉盤</button>
        </div>

        <!-- 輪盤區 -->
        <div class="flex-1 p-8 flex flex-col items-center justify-center bg-white">
            <div id="wheel-container" class="mb-12">
                <div class="pointer"></div>
                <canvas id="canvas" width="800" height="800"></canvas>
            </div>
            <button id="spin-btn" onclick="spin()" class="w-full max-w-sm py-6 bg-blue-600 text-white text-4xl font-black rounded-3xl shadow-xl active:scale-95 transition-all">START</button>
        </div>
    </div>

    <!-- 新增獎項彈窗 -->
    <div id="add-prize-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[250] p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h3 class="font-black mb-4 text-slate-800 text-xl">新增獎項</h3>
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 mb-2">手動輸入</label>
                <input id="new-prize-name" type="text" class="w-full p-4 border rounded-xl mb-4 font-bold outline-none focus:border-blue-500" placeholder="例如：特別獎">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-400 mb-2">快速加入</label>
                <button onclick="confirmAddPrize('加碼')" class="w-full py-3 bg-orange-100 text-orange-600 rounded-xl font-black border-2 border-orange-200 hover:bg-orange-200 transition-colors italic">⚡ 快速加入：加碼</button>
            </div>
            <div class="flex gap-2 border-t pt-6">
                <button onclick="confirmAddPrize()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">確認新增</button>
                <button onclick="closeAddPrizeModal()" class="flex-1 py-3 bg-slate-100 text-slate-400 rounded-xl font-bold">取消</button>
            </div>
        </div>
    </div>

    <!-- 隱藏後台 -->
    <div id="secret-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[100] p-6">
        <div class="bg-white rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <h2 id="admin-title" class="text-2xl font-black text-blue-600 mb-4 border-b pb-2">後台管理</h2>
            
            <div class="mb-6">
                <label class="block font-bold text-slate-700 mb-2 text-sm">隱藏排程設定</label>
                <p class="text-xs text-slate-500 mb-2">格式：獎項=名字1,名字2|總次數</p>
                <textarea id="rules-input" class="w-full h-32 p-4 border-2 rounded-xl font-mono text-sm" placeholder="七獎=Nathan,Yoga|9"></textarea>
            </div>

            <div class="mb-6">
                <label class="block font-bold text-slate-700 mb-2 text-sm">全獎項中獎人士紀錄</label>
                <textarea id="history-log" class="w-full h-40 p-4 border-2 rounded-xl font-mono text-sm bg-slate-50" readonly placeholder="目前尚無獲獎紀錄..."></textarea>
                <button onclick="clearHistory()" class="mt-2 text-[10px] text-red-500 font-bold hover:underline">清除紀錄</button>
            </div>

            <div class="flex flex-col items-end">
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-6 py-2 text-slate-400 font-bold">關閉視窗</button>
                    <button onclick="saveRules()" class="px-8 py-2 bg-blue-600 text-white rounded-xl font-bold shadow-lg">儲存設定</button>
                </div>
                <!-- 紅點現在顯示在儲存設定按鈕正下方 -->
                <div id="status-indicator"></div>
            </div>
        </div>
    </div>

    <!-- 中獎視窗 -->
    <div id="result-overlay" class="hidden fixed inset-0 bg-slate-900/95 flex items-center justify-center z-[200]">
        <div class="bg-white p-12 rounded-[4rem] text-center shadow-2xl max-w-sm w-full border-[16px] border-blue-600">
            <h3 id="res-prize" class="text-blue-600 font-black mb-2 text-xl"></h3>
            <h2 id="res-name" class="text-6xl font-black text-slate-800 mb-8 tracking-tighter"></h2>
            <button onclick="closeResult()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-xl">確認收錄</button>
        </div>
    </div>

    <script>
        let names = [];
        let schedules = {}; 
        let drawCounts = {}; 
        let winnerHistory = []; 
        let isSpinning = false;
        let rotation = 0;
        let secretClicks = 0;
        let jeffClicks = 0; 
        let isJeffRuleEnabled = false; 

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        window.onload = () => {
            const prizes = ["頭獎", "二獎", "三獎", "四獎", "五獎", "六獎", "七獎"];
            prizes.forEach(p => addPrizeToUI(p));
            updateNames();

            // 觸發後台
            document.getElementById('secret-trigger').onclick = () => {
                secretClicks++;
                if(secretClicks >= 5) {
                    document.getElementById('secret-modal').classList.remove('hidden');
                    secretClicks = 0;
                }
            };

            // 隱藏規則啟動：連點後台標題，紅點在按鈕下方一閃即逝
            document.getElementById('admin-title').onclick = () => {
                jeffClicks++;
                if(jeffClicks >= 5) {
                    isJeffRuleEnabled = !isJeffRuleEnabled;
                    flashStatusDot();
                    jeffClicks = 0;
                }
            };
        };

        function flashStatusDot() {
            const dot = document.getElementById('status-indicator');
            dot.classList.add('flash');
            setTimeout(() => {
                dot.classList.remove('flash');
            }, 500);
        }

        function addPrizeToUI(prizeName) {
            const container = document.getElementById('prize-list');
            const isDefault = ["頭獎", "二獎", "三獎", "四獎", "五獎", "六獎", "七獎"].includes(prizeName);
            const btn = document.createElement('div');
            btn.className = `prize-chip px-3 py-1 bg-white rounded-lg text-xs font-bold ${container.children.length === 0 ? 'active' : ''}`;
            let html = `<span>${prizeName}</span>`;
            if(!isDefault) { html += `<span class="delete-prize" onclick="event.stopPropagation(); this.parentElement.remove();">×</span>`; }
            btn.innerHTML = html;
            btn.onclick = function() {
                if(isSpinning) return;
                document.querySelectorAll('.prize-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('current-prize-input').value = prizeName;
                updateDrawCounter();
            };
            container.appendChild(btn);
            if(container.children.length === 1) { document.getElementById('current-prize-input').value = prizeName; }
        }

        function openAddPrizeModal() { document.getElementById('add-prize-modal').classList.remove('hidden'); }
        function closeAddPrizeModal() { 
            document.getElementById('add-prize-modal').classList.add('hidden');
            document.getElementById('new-prize-name').value = '';
        }
        function confirmAddPrize(fastName) {
            const val = fastName || document.getElementById('new-prize-name').value.trim();
            if(val) { addPrizeToUI(val); closeAddPrizeModal(); }
        }

        function updateNames() {
            names = document.getElementById('names-input').value.split('\n').map(n => n.trim()).filter(n => n);
            document.getElementById('participant-count-display').innerText = `人數: ${names.length}`;
            drawWheel();
        }

        function updateDrawCounter() {
            const prize = document.getElementById('current-prize-input').value;
            document.getElementById('prize-draw-count').innerText = drawCounts[prize] || 0;
        }

        function drawWheel() {
            const n = names.length;
            if(n === 0) { ctx.clearRect(0,0,800,800); return; }
            const arc = (Math.PI * 2) / n;
            const colors = ["#3b82f6", "#f59e0b", "#10b981", "#ef4444", "#8b5cf6", "#ec4899", "#6366f1", "#14b8a6"];
            ctx.clearRect(0,0,800,800);
            for(let i=0; i<n; i++) {
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(400, 400);
                ctx.arc(400, 400, 380, i*arc, (i+1)*arc);
                ctx.fill();
                ctx.save();
                ctx.translate(400, 400);
                ctx.rotate(i*arc + arc/2);
                ctx.fillStyle = "white";
                const fontSize = n > 25 ? 20 : (n > 15 ? 28 : 36);
                ctx.font = `900 ${fontSize}px Noto Sans TC`;
                ctx.textAlign = "right";
                ctx.fillText(names[i], 360, fontSize/3);
                ctx.restore();
            }
        }

        function spin() {
            if(isSpinning || names.length === 0) return;
            const prize = document.getElementById('current-prize-input').value;
            isSpinning = true;
            let targetIdx = -1;
            const JEFF = "Jeff";

            // 1. 二獎必給 Jeff (需隱藏機制啟動)
            if(isJeffRuleEnabled && prize === "二獎" && names.includes(JEFF)) {
                targetIdx = names.indexOf(JEFF);
            } 
            // 2. 智慧排程邏輯
            else if(schedules[prize] && schedules[prize].length > 0) {
                let next = schedules[prize][0];
                const isBonus = prize.indexOf("加碼") !== -1;
                if(next === "RAND") {
                    let pool = names.map((_,i) => i).filter(i => isBonus || names[i] !== JEFF);
                    targetIdx = pool[Math.floor(Math.random() * pool.length)];
                } else {
                    targetIdx = names.indexOf(next);
                    if(targetIdx === -1) {
                        let pool = names.map((_,i) => i).filter(i => isBonus || names[i] !== JEFF);
                        targetIdx = pool[Math.floor(Math.random() * pool.length)];
                    }
                }
            } 
            // 3. 一般隨機邏輯 (預設排除 Jeff，除非是加碼獎項)
            if(targetIdx === -1) {
                const isBonus = prize.indexOf("加碼") !== -1;
                let pool = names.map((_,i) => i).filter(i => isBonus || names[i] !== JEFF);
                targetIdx = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : 0;
            }

            const arcSize = 360 / names.length;
            const stopAt = 270 - (targetIdx * arcSize) - (arcSize / 2) + (Math.random()*8-4);
            const rounds = (12 + Math.floor(Math.random()*5)) * 360;
            rotation = rotation + rounds + (stopAt - (rotation % 360));
            canvas.style.transform = `rotate(${rotation}deg)`;

            setTimeout(() => {
                const winner = names[targetIdx];
                document.getElementById('res-prize').innerText = prize;
                document.getElementById('res-name').innerText = winner;
                document.getElementById('result-overlay').classList.remove('hidden');
                if(!drawCounts[prize]) drawCounts[prize] = 0;
                drawCounts[prize]++;
                winnerHistory.push(`${prize}：${winner}`);
                updateHistoryUI();
                updateDrawCounter();
                if(schedules[prize]) schedules[prize].shift();
                names.splice(targetIdx, 1);
                document.getElementById('names-input').value = names.join('\n');
                isSpinning = false;
                updateNames();
            }, 5000);
        }

        function updateHistoryUI() { document.getElementById('history-log').value = winnerHistory.join('\n'); }
        function clearHistory() { if(confirm('確定要清除所有中獎紀錄嗎？')) { winnerHistory = []; updateHistoryUI(); } }
        function saveRules() {
            const raw = document.getElementById('rules-input').value.trim();
            schedules = {};
            raw.split('\n').forEach(line => {
                const parts = line.split('=');
                if(parts.length === 2) {
                    const pName = parts[0].trim();
                    const sub = parts[1].split('|');
                    const winners = sub[0].split(',').map(s => s.trim()).filter(s => s);
                    const total = sub[1] ? parseInt(sub[1]) : winners.length;
                    let arr = new Array(total).fill("RAND");
                    let pos = Array.from({length: total}, (_, i) => i);
                    for (let i = pos.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pos[i], pos[j]] = [pos[j], pos[i]]; }
                    winners.forEach((w, i) => { if(i < total) arr[pos[i]] = w; });
                    schedules[pName] = arr;
                }
            });
            document.getElementById('secret-modal').classList.add('hidden');
            jeffClicks = 0;
        }

        function closeModal() { document.getElementById('secret-modal').classList.add('hidden'); jeffClicks = 0; }
        function closeResult() { document.getElementById('result-overlay').classList.add('hidden'); }
        function initWheel() { updateNames(); }
    </script>
</body>
</html>
